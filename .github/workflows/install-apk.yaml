name: Install Extract APK
run-name: ${{ github.event_name == 'workflow_dispatch' && format('Install Extract - {0}', github.event.inputs.run_name) || 'Install Extract APK' }}

on:
  push:
    branches:
      - main
  schedule:
    - cron: '30 5,15 * * *'
    
  workflow_dispatch:
    inputs:
      apk_zip_url:
        description: 'url to download apks zipped'
        required: true
        type: string
        default: https://url/apks.zip
      run_name:
        required: false
        type: string
env:
  avd_port: 9999
  avd_name: localhost:9999
  default_apk_zip_url: https://github.com/clearbluejar/apk-install/releases/download/v0.0.1/example.apk.zip
  all_apk_dir: all_apks

jobs:
  generate-matrix:    
    runs-on: ubuntu-latest    
    outputs:
      apkpaths: ${{ steps.getpaths.outputs.apkpaths }}
      matrix: ${{ steps.getpaths.outputs.matrix }}
    steps:      
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Download and unzip APKs
        run: |
          mkdir ${{env.all_apk_dir}}          
          # worfklow_dispatch
          [ -n "${{inputs.apk_zip_url}}" ] && wget ${{inputs.apk_zip_url}} -O ${{env.all_apk_dir}}.zip
          # default run
          [ -z "${{inputs.apk_zip_url}}" ] && wget ${{env.default_apk_zip_url}} -O ${{env.all_apk_dir}}.zip
          unzip ${{env.all_apk_dir}}.zip -d ${{env.all_apk_dir}}
          find .

      - name: Setup paths
        id: getpaths
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import zipfile

          apk_dir = pathlib.Path(os.environ["APK_DIR"])
          allowed_abis = {"arm64-v8a", "armeabi-v7a", "x86", "x86_64"}
          apk_paths = [str(path) for path in apk_dir.rglob("*.apk")]
          matrix = []

          for path in apk_dir.rglob("*.apk"):
              abis = set()
              try:
                  with zipfile.ZipFile(path) as zf:
                      for name in zf.namelist():
                          if name.startswith("lib/") and name.count("/") >= 2:
                              abi = name.split("/")[1]
                              if abi in allowed_abis:
                                  abis.add(abi)
              except zipfile.BadZipFile:
                  continue

              # 如果没有 native 库，则认为对所有默认 ABI 都可用
              target_abis = sorted(abis) if abis else sorted(allowed_abis)
              for abi in target_abis:
                  matrix.append({"apkpath": str(path), "arch": abi})

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"apkpaths={json.dumps(apk_paths)}\n")
              fh.write(f"matrix={json.dumps(matrix)}\n")
          PY
        env:
          APK_DIR: ${{ env.all_apk_dir }}
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.all_apk_dir}}
          path: ${{env.all_apk_dir}}
          retention-days: 15

  download-install-and-extract:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name : install adb
        run: | 
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y adb aapt
      - name: Install reDroid dependencies
        run: |
          set -euxo pipefail
          ## install required kernel modules          
          sudo apt-get install -y linux-modules-extra-`uname -r`
          sudo modprobe binder_linux devices="binder,hwbinder,vndbinder"
          #sudo modprobe ashmem_linux          
      - name: Run emulator
        run: |
          set -euxo pipefail
          mkdir data
          docker run -itd --rm --privileged --pull always -v $(pwd)/data:/data -p ${{env.avd_port}}:5555 redroid/redroid:12.0.0-latest          

      - name: Download runner artifacts 
        uses: actions/download-artifact@v4
        with:
          name: ${{env.all_apk_dir}}
          path: ${{env.all_apk_dir}}
        

      - name: adb connect install
        run: |                    
          set -euxo pipefail
          adb start-server
          for i in {1..30}; do
            adb connect ${{env.avd_name}} || true
            adb -s ${{env.avd_name}} wait-for-device || true
            boot=$(adb -s ${{env.avd_name}} shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$boot" = "1" ]; then
              break
            fi
            sleep 5
          done
          adb devices -l 
          adb -s ${{env.avd_name}} install --abi ${{matrix.arch}} "${{matrix.apkpath}}"
          
      - name: adb start main activity
        run: |                    
          # adb -s localhost:5555 shell am start -n com.whatsapp/com.whatsapp.Main          
          ./adb-run.sh "${{matrix.apkpath}}"

      - name: get package name ver
        run : |
          echo "apkpkgver=$(./get-pkgver.sh '${{matrix.apkpath}}')" >> "$GITHUB_ENV"
          echo "apkpkg=$(./get-pkg.sh '${{matrix.apkpath}}')" >> "$GITHUB_ENV"
          echo "$apkpkgver"         
          echo "$apkpkg"     

      - name: validate package metadata
        run: |
          if [ -z "${{ env.apkpkgver }}" ] || [ -z "${{ env.apkpkg }}" ]; then
            echo "Failed to parse package info from ${{ matrix.apkpath }}"
            echo "aapt dump badging output:"
            aapt dump badging "${{ matrix.apkpath }}" || true
            exit 1
          fi

      - name: create output dir
        run: | 
          mkdir -p "${{ env.apkpkgver }}"

      - name: aapt dump badging
        run: | 
          aapt dump badging "${{matrix.apkpath}}" >  ${{ env.apkpkgver }}/${{ env.apkpkgver }}.badging.txt         
          cat ${{ env.apkpkgver }}/${{ env.apkpkgver }}.badging.txt
      
      - name: fix data permissions
        if: always()
        run: | 
          set -euxo pipefail
          # stop docker containers
          running=$(docker ps -aq)
          if [ -n "$running" ]; then
            docker stop $running
          fi
          sudo chown -R runner:runner data

      - name: compress archive data
        run: |
          mv data data-${{ env.apkpkgver }}-${{matrix.arch}} 
          tar cvzf ${{ env.apkpkgver }}/${{ env.apkpkgver }}.${{matrix.arch}}.data.tar.gz data-${{ env.apkpkgver }}-${{matrix.arch}}/data/${{ env.apkpkg }}
      
      - name: Upload data
        uses: actions/upload-artifact@v4
        if: ${{ always() && env.apkpkgver != '' }}
        with:
            name: all_package_data-${{ env.apkpkgver }}-${{ matrix.arch }}
            path: ${{ env.apkpkgver }}
            retention-days: 25
            
      - name: Upload all data
        uses: actions/upload-artifact@v4
        if: ${{ always() && env.apkpkgver != '' }}
        with:
            name: all_data-${{ env.apkpkgver }}-${{ matrix.arch }}
            path: data-${{ env.apkpkgver }}-${{matrix.arch}}/data/
            retention-days: 5
